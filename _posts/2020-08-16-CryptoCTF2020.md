# Crypto CTF 2020 

![](../img/2020-08-16-11-00-28.png)  


Cu·ªëi tu·∫ßn n√†y m√¨nh c√≥ ch∆°i CryptoCTF 2020 v√† k·∫øt th√∫c v·ªõi 7 challenges ƒë∆∞·ª£c ho√†n th√†nh üòÅ Kh√¥ng ph·∫£i qu√° t·ªá v·ªõi m·ªôt th·∫±ng l√¢u r·ªìi kh√¥ng ch∆°i Crypto nh∆∞ m√¨nh. C√≤n kh√° nhi·ªÅu challenge m√¨nh ch∆∞a th·ªÉ ho√†n th√†nh üòÇüòÇ v√† script bruteforce th√¨ v·∫´n ch·∫°y xuy√™n m√†n ƒë√™m m√† kh√¥ng bi·∫øt bao gi·ªù m·ªõi ra k·∫øt qu·∫£. Sau gi·∫£i n√†y, m√¨nh m·ªõi bi·∫øt m√°y m√¨nh c√≤n y·∫øu h∆°n c·∫£ `google cocacl`. sad =((  

# Table of contents  
 + [**Three ravens**](#wu1)  
 + [**Amsterdam**](#wu2)  
 + [**Gambler**](#wu3)  
 + [**Model**](#wu4)  
 + [**Abbot**](#wu5)  
 + [**Haven**](#wu6)  

<a name="wu1"></a>  

# Three ravens  

```python
def keygen(nbit):
	while True:
		p, q, r = [getPrime(nbit) for _ in range(3)]
		if isPrime(p + q + r):
			pubkey = (p * q * r, p + q + r)
			privkey = (p, q, r)
			return pubkey, privkey
```
ƒê√¢y l√† m·ªôt challenge RSA ƒë∆°n gi·∫£n. V·ªõi h√†m `keygen` nh∆∞ tr√™n. Ta th·∫•y public key ƒë∆∞·ª£c t·∫°o th√†nh t·ª´ hai th√†nh ph·∫ßn l√† `p*q*r` v√† `p+q+r`.  

T·ªõi ƒë√¢y, ch·∫Øc c√≥ b·∫°n r·∫•t d·ªÖ b·ªã l·ª´a khi follow v√†o vi·ªác ph√¢n t√≠ch t√¨m `p, q,r` tuy nhi√™n ƒëi·ªÅu ƒë√≥ l√† ho√†n to√†n kh√¥ng c·∫ßn thi·∫øt khi `p+q+r` l√† m·ªôt s·ªë nguy√™n t·ªë v√† ƒë√£ bi·∫øt r√µ gi√° tr·ªã.  

Do ƒë√≥, ta c√≥ th·ªÉ quy v·ªÅ module l√† `p+q+r` r·ªìi t√¨m phi c·ªßa n√≥ v√† gi·∫£i nh∆∞ b√†i to√°n RSA th√¥ng th∆∞·ªùng.  

```
enc = pow(m, e, n) 
-> enc = enc % (p+q+r) === pow(m, e, p+q+r) 
```  

<a name="wu2"></a>  

## Amsterdam   

**Challenges** 

```python
def comb(n, k):
	if k > n :
		return 0
	k = min(k, n - k)
	u = reduce(operator.mul, range(n, n - k, -1), 1)
	d = reduce(operator.mul, range(1, k + 1), 1)
	return u // d 

def encrypt(msg, n, k):
    # part 1 
	msg = bytes_to_long(msg.encode('utf-8'))
	if msg >= comb(n, k):
		return -1
	m = ['1'] + ['0' for i in range(n - 1)]
	for i in range(1, n + 1):
		if msg >= comb(n - i, k):
			m[i-1]= '1'
			msg -= comb(n - i, k)
			k -= 1

	# part 2 
	m = int(''.join(m), 2)
	i, z = 0, [0 for i in range(n - 1)]
	c = 0
	while (m > 0):
		if m % 4 == 1:
			c += 3 ** i 
			m -= 1
		elif m % 4 == 3:
			c += 2 * 3 ** i
			m += 1
		m //= 2
		i += 1
	return c
```  

H√†m `encrypt` c√≥ th·ªÉ ƒë∆∞·ª£c chia th√†nh hai ph·∫ßn : 
 + ph·∫ßn 1 : m√£ h√≥a d·ª±a tr√™n h√†m comb, chuy·ªÉn th√†nh d·∫°ng bit nh∆∞ ki·ªÉu c∆° s·ªë comb ·∫•y :v  
 + ph·∫ßn 2 : d·∫°ng d·∫°ng ki·ªÉu chuy·ªÉn v·ªÅ c∆° s·ªë 3 :v  

Vi·ªác c·ªßa ch√∫ng ta l√† vi·∫øt h√†m ƒë·∫£o ng∆∞·ª£c hai ph·∫ßn n√†y l·∫°i.  

### Part 2  

ƒê·ªëi v·ªõi part2, tr∆∞·ªõc h·∫øt ta t√¨m ph√¢n t√≠ch c∆° s·ªë 3 c·ªßa ciphertext c√≥ d·∫°ng nh∆∞ : c<sub>1</sub>c<sub>2</sub>c<sub>3</sub>...  

Ti·∫øp ƒë·∫øn, ta t√≠nh t·ª´ cu·ªëi l√™n, x√©t 3 tr∆∞·ªùng h·ª£p :  

 + n·∫øu `c<sub>i</sub> == 1` th√¨ `2 * m + 1` 
 + n·∫øu `c<sub>i</sub> == 2` th√¨ `2 * m - 1`
 + n·∫øu `c<sub>i</sub> == 0` th√¨ `2 * m + 0`  


### Part 1  

Sau khi d·ªãch ng∆∞·ª£c ƒë∆∞·ª£c part 2 ta thu ƒë∆∞·ª£c m l√† b·∫£n m√£ c·ªßa part 1. ƒê·ªÉ d·ªãch ng∆∞·ª£c part 1, ta chuy·ªÉn `m` sang h·ªá nh·ªã ph√¢n r·ªìi c≈©ng th·ª±c hi·ªán c√¥ng vi·ªác d·ªãch ng∆∞·ª£c t∆∞∆°ng t·ª± nh∆∞ vi·ªác chuy·ªÉn c∆° s·ªë v·∫≠y ƒë√≥. Kh√¥ng c√≥ g√¨ kh√≥ khƒÉn c·∫£.  

<a name="wu3"></a>   

## Gambler  

B√†i n√†y cho ph√©p ch√∫ng ta netcat ƒë·∫øn m·ªôt server :  ` nc 05.cr.yp.toc.tf 33371`. Vi·ªác ƒë·∫ßu ti√™n, ch√∫ng ta c·∫ßn bypass th·ª≠ th√°ch :  

```
Please submit a printable string X, such that sha1(X)[-6:] = f8496e and len(X) = 31
```  

ƒê√¢y l√† c√¥ng ƒëo·∫°n nh·∫±m h·∫°n ch·∫ø bruteforce server üòêüòê Nh∆∞ng c≈©ng g√¢y r·∫•t nhi·ªÅu annoying cho ng∆∞·ªùi ch∆°i. Khi m√† ph·∫£i ƒë·ª£i r·∫•t l√¢u.  

ƒê·ªÉ bypass ƒëo·∫°n hash, m√¨nh xin ƒë∆∞·ª£c 1 script nh∆∞ sau :  

```python

rx_hash = re.compile(b'Please submit a printable string X, such that (.*)\(X\)\[-6\:\] \= (.*) and len\(X\) \= (.*)')
# You must pass this PoW challenge :P')
t = remote(ip, port)
context.log_level = "debug"
resp = t.recvline();print(resp)
type_hash,valid_hash,len_mess = rx_hash.findall(resp)[0]
type_hash = eval(b'hashlib.'+type_hash)
valid_hash,len_mess = valid_hash.decode(),int(len_mess)
print(valid_hash,len_mess)
for test in itertools.product(string.printable,repeat=len_mess):
    tmp = ''.join(test).encode()
    if type_hash(tmp).hexdigest()[-6:]==valid_hash:    
        print("[+]Found:",tmp)
``` 

Aww waiting time ....  

![](../img/2020-08-16-11-35-47.png)  

Sau khi v∆∞·ª£t qua challenges poc,ch√∫ng ta ƒë·∫øn v·ªõi ch∆∞∆°ng tr√¨nh ch√≠nh. 

![](../img/2020-08-16-11-37-16.png)  

C√≥ 3 options ƒë·ªÉ l·ª±a ch·ªçn :  
 + [**C**]ipher flag!
 + [**E**]ncryption function!
 + [**T**]ry the encryption!  


Ch√∫ng ta c√≥ h√†m m√£ h√≥a kh√° ƒë∆°n gi·∫£n :  

```python
def encrypt(m, p, a, b):
    assert m < p and isPrime(p)
    return (m ** 3 + a * m + b) % p
```

V√† ƒë·ªìng th·ªùi c√≥ th·ªÉ d√πng h√†m m√£ h√≥a ƒë·ªÉ m√£ h√≥a gi√° tr·ªã b·∫•t k√¨.  
B√†i n√†y ta kh√¥ng bi·∫øt g√¨ v·ªÅ `public key`. ƒê√¢y l√† m·ªôt d·∫°ng `side-channel-attack`. Ta s·∫Ω s·ª≠ d·ª•ng h√†m m√£ h√≥a ƒë·ªÉ thu ƒë∆∞·ª£c th√¥ng tin kh√°c nhau.  

ƒê·∫ßu ti√™n, ch√∫ng ta c·∫ßn t√¨m ƒë∆∞·ª£c `a, b, p`.  

### T√¨m b  

Ta m√£ h√≥a v·ªõi `m = 0`. Khi ƒë√≥, ta s·∫Ω thu l·∫°i ƒë∆∞·ª£c m.  

### T√¨m a  

Ta m√£ h√≥a v·ªõi `m = 1`. Khi ƒë√≥, cipher text thu ƒë∆∞·ª£c s·∫Ω c√≥ d·∫°ng ` 1 + a + b`. Ta l·∫•y ƒë√≥ r·ªìi tr·ª´ ƒëi `b` t√¨m ƒë∆∞·ª£c ·ªü b∆∞·ªõc tr∆∞·ªõc l√† ra `a`. Kh√¥ng quan tr·ªçng √¢m d∆∞∆°ng v√¨ ta ƒëang th·ª±c hi·ªán c√°c ph√©p to√°n tr√™n module `p`.  

### T√¨m p  

Tr∆∞·ªõc h·∫øt c·∫ßn x√°c ƒë·ªãnh s·ªë bit c·ªßa `p`. ƒê·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu n√†y, ta ch·ªâ c·∫ßn th·ª≠ m√£ h√≥a c√°c ƒëo·∫°n vƒÉn b·∫£n c√≥ s·ªë bit c·ª• th·ªÉ, n·∫øu qu√° l·ªõn th√¨ s·∫Ω b·ªã server t·ª´ ch·ªëi. Sau khi l√†m v√†i c√¥ng vi·ªác nh√†m ch√°n ƒë√≥, ta t√¨m ƒë∆∞·ª£c ƒë·ªô d√†i bit c·ªßa `p` l√† 512.  
ƒê·ªô d√†i c·ªßa `a`, `b` kh√° l√† x·∫•p x·ªâ.  

Do ƒë√≥, ta s·∫Ω ti·∫øn h√†nh m√£ h√≥a m·ªôt s·ªë l√†m cho t·ªïng `m ** 3 + a * m + b` h∆°i v∆∞·ª£t s·ªë `p` ƒë·ªÉ c√≥ ƒë∆∞·ª£c ƒë·ªìng d∆∞.  

M√¨nh ch·ªçn `m = 1024` do n√≥ c√≥ 10  bit.  

Sau ƒë√≥, ch·ªâ c·∫ßn ƒëi factor `m ** 3 + a * m + b - encrypt(m)`. Do s·ªë ƒë√≥ c√≥ m·ªôt ∆∞·ªõc nguy√™n t·ªë l√† `p` n√™n c√°c ∆∞·ªõc c√≤n l·∫°i r·∫•t b√©. Ta ch·ªâ c·∫ßn ƒëi t√¨m h·∫øt c√°c ∆∞·ªõc nguy√™n t·ªë b√© ƒë√≥ l√† ra ƒë∆∞·ª£c `p`.  

```python
def factor(n) : 
    i = 2
    while True : 
        if n % i != 0 : 
            i += 1 
            continue 
        n = n // i 
        if isPrime(n) :
            log.success("p = %d" % n) 
            return n 
        else : 
            i = 2
```

### T√¨m m  

Cu·ªëi c≈©ng ta c√≤n ph·∫£i ƒëi gi·∫£i ph∆∞∆°ng tr√¨nh ƒë·ªìng d∆∞ :  
```
m ** 3 + a * m + b == c [mod p]  
```

ƒê·ªÉ gi·∫£i ph∆∞∆°ng tr√¨nh ƒë·ªìng d∆∞ n√†y, ta c√≥ th·ªÉ d√πng sage :  

```python
P.<x> = PolynomialRing(Zmod(p))
px = x^3 + a*x + b - enc
px.roots()
```

<a name="wu4"></a>  

## Model  

Challenge cho ch√∫ng ta m·ªôt k·∫øt n·ªëi netcat : `nc 04.cr.yp.toc.tf 8001`.  

Sau khi k·∫øt n·ªëi v·ªõi server, ta thu ƒë∆∞·ª£c source code ch∆∞∆°ng tr√¨nh v√† public key c≈©ng nh∆∞ b·∫£n m√£ :  

```python
def genkey(nbit):
    while True:
        p, q = getPrime(nbit), getPrime(nbit)
        if gcd((p-1) // 2, (q-1) // 2) == 1:
            P, Q = (q-1) // 2, (p-1) // 2
            r = inverse(Q, P)
            e = 2 * r * Q  - 1
            return(p, q, e)

def encrypt(msg, pubkey):
    e, n = pubkey
    return pow(bytes_to_long(msg), e, n)
    
n = 22447939572660807243308311289931892388365003669295700536867549633516713302453449324551919078666579915228197329187957917606818773604750002085863795021573178205773106546180139131020488467079657935229154001115991655742518868268629188594620851356924003852790942275924974402283406526148241684608179444315229103426809357935934533678277547966131705128853300090054886642128377116887220743333192761043553517670906378741523287780365106472937165368086627194139603557301544166278454888781463977757454460941847745786162533949238314685730701370513058871625108253496496061141594580295085687778515092738688529611359937257490634009441
# encrypt(flag, pubkey) = 7077520491256532374746917092294372631159931429224627631277965754818470073050063217627949608886714162580335912377352526133928188875062304905216968707579647571827680185831458362793640116823151837815111529328335611637374040111401270720217810466002560778809452855267509199100924501274810986262278726223960807532548562269518378597625273153040483747771278104618407054256867157644515603610805802063844674910222372134224664069427433965202485777818826295907843818426157007476171522458334177501092523660821973889154502167708640003686344183269890123271408858838607997338568904026390772516584281907312300410645883428656930233120           

```  

B√†i n√†y c·∫ßn d√πng m·ªôt ch√∫t t√≠nh ch·∫•t to√°n h·ªçc. Nh∆∞ng c≈©ng kh√¥ng ph·∫£i qu√° ph·ª©c t·∫°p üòÅ  

L·ªó h·ªïng c·ªßa b√†i n√†y n·∫±m ·ªü ch·ªó kh√≥a `e` ƒë∆∞·ª£c thi·∫øt l·∫≠p t√≠ch h·ª£p theo `private key`. Vi·∫øt l·∫°i `e` :  

```
e = 2 * r * Q - 1 = r * (p-1) - 1 
e == -1 [mod phi(p)]
```

Ta c√≥ t√≠nh ch·∫•t kh√° ƒë·∫∑c bi·ªát c·ªßa e, do ƒë√≥ n·∫øu ta ch·ªâ x√©t theo module p th√¨ v·ªõi m·ªçi b·∫£n m√£m ta c√≥ :  
```
c = encrypt(m) = pow(m, e, n) [mod p] 
c = pow(m, -1, n) [mod p] 
m * c == 1 [mod p]  
```

Do ƒë√≥, ta c√≥ `m * c - 1` l√† b·ªôi c·ªßa p v·ªõi m·ªçi m. Do ƒë√≥, ta c√≥ th·ªÉ ti·∫øn h√†nh m√£ h√≥a r·∫•t nhi·ªÅu b·∫£n r√µ nh∆∞ th·∫ø, l·∫•y ∆∞·ªõc chung l·ªõn nh·∫•t ta s·∫Ω c√≥ c∆° h·ªôi r·∫•t l·ªõn ƒë·ªÉ t√¨m l·∫°i ƒë∆∞·ª£c `p`. ü§©  

Cu·ªëi c√πng, sau khi bi·∫øt ƒë∆∞·ª£c p th√¨ m·ªçi chuy·ªán c√≤n l·∫°i kh√¥ng ƒë√°ng nh·∫Øc t·ªõi.  

M·ªôt b√†i kh√¥ng qu√° ph·ª©c t·∫°p nh∆∞ng n·∫øu kh√¥ng quen v·ªõi s·ªë h·ªçc th√¨ maybe s·∫Ω h∆°i kh√≥ khƒÉn.  



<a name="wu5"></a>  

## Abbot  

B√†i n√†y m√¨nh nghƒ© ch·∫Øc ra nh·ªØng l√∫c cu·ªëi n√™n m·ªõi c√≥ √≠t ng∆∞·ªùi l√†m ƒë∆∞·ª£c nh∆∞ th·∫ø. Nh√¨n chung ƒë√¢y l√† m·ªôt b√†i rev :v C√≥ ch√∫t t√≠nh ch·∫•t s·ªë h·ªçc kh√° th√∫ v·ªã.  

Ch√∫ng ta c√≥ 3 h√†m m√£ h√≥a kh√° t∆∞∆°ng t·ª± nhau ƒë·ªÉ reverse. N√≥i chung l√† d·ªãch ng∆∞·ª£c ƒë∆∞·ª£c m·ªôt th√¨ ta c≈©ng d·ªãch ng∆∞·ª£c ƒë∆∞·ª£c c√°c h√†m c√≤n l·∫°i th√¥i.  

```python
def me(msg):
	if len(msg) == 1 :
		return ord(msg)
	msg = msg[::-1]
	reducer = len(msg) - 1
	resultNum, resultDen = frac(ord(msg[0]), reducer).denominator, frac(ord(msg[0]), reducer).numerator
	reducer -= 1
	for i in range(1, len(msg)-1):
		result =  ord(msg[i]) +  frac(resultNum, resultDen)
		resultDen, resultNum  = result.denominator, result.numerator
		resultDen, resultNum =  resultNum, reducer * resultDen
		reducer -= 1	
	result = ord(msg[-1]) + frac(resultNum, resultDen)
	resultDen, resultNum  = result.denominator, result.numerator
	return (resultNum, resultDen)
``` 

Tr√¥ng qua h√†m m√£ h√≥a th√¨ kh√° l√† ph·ª©c t·∫°p khi n√≥ d√πng t·ªõi `fraction` v√† ti·∫øn h√†nh ƒë·∫£o t·ª≠ s·ªë v√† m·∫´u s·ªë li√™n t·ª•c. ƒê·ªëi v·ªõi nh·ªØng b√†i nh∆∞ n√†y, c·ª© l√†m tr√™n nh·ªØng tr∆∞·ªùng h·ª£p nh·ªè tr∆∞·ªõc ƒë·ªÉ c√≥ th·ªÉ c√≥ c√°i nh√¨n t·ªïng qu√°t v·ªÅ ch∆∞∆°ng tr√¨nh.  

Khi ƒë·ªçc ƒë·ªÅ b√†i n√†y, m√¨nh ƒë√£ li√™n h·ªá t·ªõi ` li√™n ph√¢n s·ªë `.  

![](../img/2020-08-16-12-02-36.png)  

Sau khi bi·∫øn ƒë·ªïi ki·ªÉm ch·ª©ng v·ªõi nh·ªØng tr∆∞·ªùng h·ª£p nh·ªè th√¨ m√¨nh ƒë√£ kh·∫≥ng ƒë·ªãnh ƒë∆∞·ª£c ph·ªèng ƒëo√°n tr√™n.  
ƒê·ªëi v·ªõi h√†m m√£ h√≥a `me`, li√™n ph√¢n s·ªë s·∫Ω c√≥ d·∫°ng :  


![](../img/2020-08-16-12-09-05.png)  

Ta c√≥ ciphertext bao g·ªìm t·ª≠ s·ªë v√† m·∫´u s·ªë. Nh∆∞ v·∫≠y ta s·∫Ω c√≥ :  

a<sub>0</sub> = denominator / numerator  

Sau ƒë√≥, ta t√≠nh to√°n l·∫°i t·ª≠ s·ªë v√† m·∫´u s·ªë m·ªõi c·ªßa ph·∫ßn ph√¢n s·ªë c√≤n l·∫°i.  

Ti·∫øp ƒë·∫øn ta th·ª±c hi·ªán t√≠nh ti·∫øp a<sub>1</sub>, a<sub>2</sub> theo c√°ch t∆∞∆°ng t·ª±. B√†i n√†y l√†m tay c≈©ng ƒë∆∞·ª£c :v Tuy nhi√™n h√†m m√£ h√≥a ƒë∆∞·ª£c ch·ªçn ng·∫´u nhi√™n n√™n l√†m tay s·∫Ω m·∫•t kha kh√° th·ªùi gian. üòÇ Th√¥i th√¨ l√† d√¢n l·∫≠p tr√¨nh n√™n ng·∫°i g√¨ m√† kh√¥ng vi·∫øt h√†m.  

ƒê·∫øn ƒëo·∫°n n√†y, v·ªõi √Ω t∆∞·ªüng , m√¨nh vi·∫øt l·∫°i d·∫ßn h√†m m√£ h√≥a. ƒê·∫ßu ti√™n m√¨nh s·∫Ω vi·∫øt h√†m t√¨m ƒë·ªÉ t√¨m a<sub>0</sub>.  

```python
msg = "" 
c = denominator // numerator   
resultDen, resultNum = den - c * num, den 
```
Sau ƒë√≥, ta ti·∫øn h√†nh t·ªïng qu√°t l√™n cho c√°c tr∆∞·ªùng h·ª£p c√≤n l·∫°i. Ch√∫ √Ω l√† b√¢y gi·ªù ph·∫£i th√™m c√°c ch·ªâ s·ªë 1,2,3 ... t∆∞∆°ng ·ª©ng v·ªõi `reducer` ·ªü h√†m m√£ h√≥a. ƒê·∫øn ƒë√¢y, ta c√≥ th·ªÉ th·ª≠ b·∫±ng c√°ch m√£ h√≥a m·ªôt b·∫£n m√£ b·∫•t k√¨ v√† ti·∫øn h√†nh debug b·∫±ng c√°ch in ra gi√° tr·ªã `c` t√¨m ƒë∆∞·ª£c ·ªü m·ªói b∆∞·ªõc. N·∫øu gi√° tr·ªã sai th√¨ ta th·ª≠ thay ƒë·ªïi m·ªôt ch√∫t ƒë·ªÉ n√≥ th√†nh ƒë√∫ng :v  

Cu·ªëi c√πng sau khi ki·ªÉm tra v√† th·ª≠, m√¨nh t√¨m ƒë∆∞·ª£c h√†m gi·∫£i m√£ :  

```python
def rev_me(num, den) : 
    increaser = 1 
    msg = "" 
    resultDen = den 
    resultNum = num 
    idx = 0  
    while True :
        idx += 1  
        c = increaser * resultDen // resultNum 
        resultNum, resultDen = increaser * resultDen - c * resultNum, resultNum
        msg += chr(c) 
        if resultNum == 0 : 
            break 
        if idx > 1 : 
            increaser += 1 
    return msg  
```

Subprise l√† n√≥ kh√° na n√° v·ªõi h√†m m√£ h√≥a üòÆ C√≤n l·∫°i 2 h√†m th√¨ t∆∞∆°ng t·ª±.  

Sau ƒë√≥ ch√∫ng ta ch·ªâ c·∫ßn th·ª≠ l·∫ßn l∆∞·ª£t ba h√†m gi·∫£i m√£ v·ªõi b·∫£n m√£ ƒë·ªÉ thu ƒë∆∞·ª£c flag c·∫ßn t√¨m.  

<a name="wu6"></a>  

## Haven  

![](../img/2020-08-16-12-20-39.png)  

`Hacmao has come to haven`. :v  

```python
def matthew_effect(shire, rohan):
    gandalf = ''
    for idx, hobbit in enumerate(shire):
        gandalf += oh if ord(hobbit) ^ ord(rohan[idx]) == 0 else no
    return gandalf


def born_to_die(isengard):
    luke = 0
    for book in new_testament:
        luke ^= ord(isengard[book])
    lizzy_grant = oh + isengard[:-1] if luke == 0 else no + isengard[:-1]
    return lizzy_grant

def encrypt(flag, key) : 
    len_flag = len(flag) 
    destiny = len_flag // len_key  
    apocalypse = len_flag % len_key
    _ = 0 
    princess_leia = ''
    while _ < destiny:
        princess_leia += matthew_effect(key,
                                    flag[_ * len_key: (_ + 1) * len_key])
        key = born_to_die(key)
        _ += 1

    princess_leia += matthew_effect(key[:apocalypse], flag[_ * len_key:]) 
    enc = bytes(int(princess_leia[i: i + 8], 2)
                      for i in range(0, len_flag, 8))
    return enc
```

B√†i n√†y t√°c gi·∫£ c√≥ v·∫ª l√† fan h√¢m m·ªô c·ªßa ` ch√∫a t·ªÉ c·ªßa nh·ªØng chi·∫øc nh·∫´n ``. Nh∆∞ng ƒëi·ªÅu n√†y l·∫°i th√†nh ra m·ªôt d·∫°ng obfuscate. Kh√° l√† kh√≥ ƒë·ªçc.  

ƒê·ªìng th·ªùi, b√†i n√†y c√≥ kh√° l√† nhi·ªÅu bi·∫øn b√≠ m·∫≠t :  

```python
from heaven import seventh_seal, oh, no, new_testament
```

Sau khi ƒë·ªçc qua ch∆∞∆°ng tr√¨nh, c√≥ th·ªÉ ƒë∆∞a ra c√°i nh√¨n t·ªïng quan l√† ch∆∞∆°ng tr√¨nh l√† m·ªôt ki·ªÉu m√£ h√≥a d∆∞·ªõi d·∫°ng bit.  

`seventh_seal` l√† key c√≥ d·∫°ng bit v√† ƒë·ªô d√†i ch∆∞a bi·∫øt.  

`oh, no` l√† c√°c bit 0 ho·∫∑c 1. D·ª±a v√†o t√™n m√¨nh m·∫°nh d·∫°n ƒëo√°n `oh = 1 v√† no = 0`. Ho·∫∑c kh√¥ng th√¨ c√≥ th·ªÉ th·ª≠ l·∫ßn l∆∞·ª£t c≈©ng ƒë∆∞·ª£c ü§£  

`new_statement` ki·ªÉu l√† m·ªôt d·∫°ng ƒë·ªÉ ƒë·∫£o bit. C√°i m√† sau n√†y m√¨nh quy·∫øt ƒë·ªãnh `bruteforce` cho n√≥ nhanh.  

`flag` c√≥ d·∫°ng ·∫£nh. Do ƒë√≥, ta c√≥ ƒë∆∞·ª£c know plain text l√† header c·ªßa file jpg. File jpg c√≥ 4 lo·∫°i header :  

```python
jpg_header = b"\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01" 
#jpg_header = b"\xFF\xD8\xFF\xDB"
#jpg_header = b"\xFF\xD8\xFF\xEE"
#jpg_header = b"\xFF\xD8\xFF\xE1"
```

### T√¨m ƒë·ªô d√†i key  

B∆∞·ªõc ƒë·∫ßu ti√™n, ch√∫ng ta c·∫ßn t√¨m ƒë·ªô d√†i c·ªßa key.  

Key ƒë∆∞·ª£c thay ƒë·ªïi sau m·ªói l·∫ßn m√£ h√≥a b·∫±ng h√†m `born_to_die`.  

```python
lizzy_grant = oh + isengard[:-1] if luke == 0 else no + isengard[:-1]
```
Sau khi thay ƒë·ªïi n√≥ s·∫Ω bi·∫øn ƒë·ªïi t·ª´ d·∫°ng `axxxxx` sang `xxxxxxb`. Nh∆∞ v·∫≠y, `key[1:] == newkey[:-1]`. Ta c√≥ th·ªÉ d·ª±a tr√™n th√¥ng tin n√†y ƒë·ªÉ t√¨m ƒë·ªô d√†i key.  

H√†m `matthew_effect` th·ª±c ch·∫•t ho·∫°t ƒë·ªông nh∆∞ h√†m `xor` . Do ƒë√≥, t·ª´ `known plaintext` ta c√≥ th·ªÉ t√¨m l·∫°i ƒë∆∞·ª£c key m√£ h√≥a cho t·ª´ng block.  

V·∫≠y n√™n, t·∫°i ƒë√¢y ta s·∫Ω th·ª≠ l·∫ßn l∆∞·ª£t ƒë·ªô d√†i c·ªßa key. N·∫øu ƒë√∫ng , ta s·∫Ω thu ƒë∆∞·ª£c hai key c·ªßa hai block li√™n ti·∫øp th·ªèa m√£n ƒëi·ªÅu ki·ªán : key<sub>1</sub>[1:] == key<sub>2</sub>[:-1].  

```python
bits = 4
while True : 
    print(bits)
    if bits > len(jpg_header) : 
        break 
    len_key = bits 
    key = matthew_effect(jpg_header[:len_key], flag_enc[:len_key]) 
    key_ = matthew_effect(jpg_header[len_key:2 * len_key], flag_enc[len_key:2 * len_key])
    if key[:-1] == key_[1:] : 
        print("Found : ", bits)
        break 
    bits += 1 
```
ƒê·ªÉ tƒÉng s·ª± ch√≠nh x√°c, c√≥ th·ªÉ t√¨m nhi·ªÅu key ƒë·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán tr√™n. Cu·ªëi c√πng, m√¨nh x√°c ƒë·ªãnh ƒë∆∞·ª£c key c√≥ ƒë·ªô d√†i l√† 19.  

### Bruteforce alll  

Kh√¥ng c·∫ßn bi·∫øt nhi·ªÅu v·ªÅ to√°n, n√™n m√¨nh quy·∫øt ƒë·ªãnh bruteforce t·ª´ ƒë√¢y. Ch√∫ng ta ch·ªâ c·∫ßn bruteforce `new_statement`. N√≥ c√≥ ƒë·ªô d√†i l·ªõn nh·∫•t b·∫±ng ƒë·ªô d√†i c·ªßa key. Nh∆∞ v·∫≠y ta s·∫Ω c√≥ nhi·ªÅu nh·∫•t l√† `2**19 = 524288`, kh√¥ng ph·∫£i l√† con s·ªë qu√° l·ªõn.  

ƒê√¢y l√† m√£ h√≥a ƒë·ªëi x·ª©ng n√™n h√†m gi·∫£i m√£ c≈©ng ch√≠nh l√† h√†m m√£ h√≥a. Ta s·∫Ω ti·∫øn h√†nh gi·∫£i m√£ ƒë·∫øn khi n√†o t√¨m ƒë∆∞·ª£c flag ·ªü ƒë√∫ng d·∫°ng `jpg`.  
M√¨nh vi·∫øt m·ªôt h√†m ƒë·ªÉ check xem n√≥ c√≥ ƒë√∫ng ·ªü d·∫°ng `jpg` kh√¥ng.  

```python
def check_jpg(string) : 
    
    if string[:3] == jpg_header[3] : 
        try : 
            image = Image.open(io.BytesIO(string))
            image.verify()
            return 1 
        except : 
            return 0  
```

N·∫øu ch√∫ng ta ti·∫øn h√†nh gi·∫£i m√£ to√†n b·ªô flag th√¨ s·∫Ω r·∫•t l√¢u do flag r·∫•t l·ªõn, cho n√™n ban ƒë·∫ßu ch·ªâ c·∫ßn gi·∫£i m√£ ƒëo·∫°n ƒë·∫ßu ƒë·ªÉ check header th√¥i.  
```python
flag = encrypt(flag_enc[:12*8], key) 
``` 
Sau ƒë√≥, ƒë·ªÉ cho nhanh th√¨ m√¨nh check 3 k√≠ t·ª± ƒë·∫ßu ƒë·ªÉ xem n√≥ c√≥ ƒë√∫ng v·ªõi header c·ªßa jpg kh√¥ng. Sau ƒë√≥ m·ªõi th·ª±c hi·ªán check b·∫±ng `pillow`.  
N·∫øu `image.verify()` ƒë√∫ng th√¨ ƒë√¢y ƒë√≠ch th·ª±c l√† file ·∫£nh.  

Sau khi bruteforce xong, m√¨nh thu ƒë∆∞·ª£c file `flag.jpg`. :v  

# The End

Sau th·ªùi gian l√¢u kh√¥ng l√†m crypto, m√¨nh th·∫•y kh√° b·ªã ƒëu·ªëi v√† c√≥ kh√° nhi·ªÅu ki·∫øn th·ª©c m·ªõi m√† m√¨nh kh√¥ng bi·∫øt. Do kh√¥ng ƒë·ªãnh theo s√¢u n√™n m√¨nh c≈©ng coi ƒë√≥ l√† m·ªôt tr·∫£i nghi·ªám ƒë·ªÉ h·ªìi t∆∞·ªüng v·ªÅ th·ªùi gian ƒë·∫ßu m√¨nh ch∆°i CTF th√¥i üòÅüòÅüòÅ Nh∆∞ng tr·∫£i qua 1 ng√†y ho·∫°t ƒë·ªông li√™n t·ª•c, m√¨nh c≈©ng th·∫•y r·∫•t vui. ƒê√¢y l√† m·ªôt trong hi·∫øm k√¨ ctf m√† m√¨nh try hard nh∆∞ v·∫≠y :v  
Maybe see you next year :v  Or not :v  

~ The end   

